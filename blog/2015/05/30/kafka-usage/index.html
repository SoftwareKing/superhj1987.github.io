
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<meta name="ujianVerification" content="7625e668c8eb782e03dfa1be3a6339f7" />
	<title>kafka学习笔记 - 使用与配置 - 后端技术杂谈 | 飒然Hang</title>
	<meta name="author" content="飒然Hang">

	
	<meta name="description" content="Kafka学习笔记 - 使用与配置 此部分内容主要来自官方文档。 一. 使用 下载代码 https://www.apache.org/dyn/closer.cgi?path=/kafka/0.8.2.0/kafka_2.10-0.8.2.0.tgz tar -xzf kafka_2.10-0.8 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="后端技术杂谈 | 飒然Hang" type="application/atom+xml">
	
	<link rel="canonical" href="http://www.rowkey.me/blog/2015/05/30/kafka-usage/">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		// $(function(){
		// 	$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("superhj1987@126.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		// });
		$(function(){
			$('.profilepic').append("<img src='/images/avatar/backend_logo.png' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>
<hgroup>
  <h1>后端技术杂谈</h1>
  
    <h3>What、How、Why</h2>
  
</hgroup>

<nav id="main-nav"><ul class="main">
	<li><a href="/">首页</a></li>
    <li><a href="/blog/archives">所有文章</a></li>
</ul>

<section class="aboutme" style='margin-top:15px !important;border:1px dashed;padding:2px;overflow:scroll'>
  <h3>飒然Hang</h3>
  <p>专注于JavaEE开发、服务端基础架构、研发管理等。</p>
  <br/>
  <p>working@中华万年历;</p>
  <p>后端开发工程师@网易杭州研究院;</p>
</section>
</nav>
<nav id="sub-nav" style='margin-top:20px !important'>
	<div class="social">
		
		<a class="weibo" href="http://weibo.com/superhj1987" title="Weibo" target="_blank">Weibo</a>
		
		
			<a class="github" href="https://github.com/superhj1987" title="GitHub" target="_blank">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS" target="_blank">RSS</a>
		
	</div>
</nav>
<style type="text/css">
	span#cnzz_stat_icon_1257166229{
		display: none !important
	}
	div#ujian_BtnDiv{
		display: none !important
	}
</style>
<!-- cnzz统计 -->
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257166229'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1257166229%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Kafka学习笔记 - 使用与配置</h1>
	<div class="entry-content" itemprop="articleBody"><p>此部分内容主要来自官方文档。</p>

<h2>一. 使用</h2>

<ol>
<li><p>下载代码</p>

<p> <a href="https://www.apache.org/dyn/closer.cgi?path=/kafka/0.8.2.0/kafka_2.10-0.8.2.0.tgz">https://www.apache.org/dyn/closer.cgi?path=/kafka/0.8.2.0/kafka_2.10-0.8.2.0.tgz</a></p>

<pre><code> tar -xzf kafka_2.10-0.8.2.0.tgz
 cd kafka_2.10-0.8.2.0
</code></pre></li>
<li><p>启动服务器</p>

<p> kafka依赖zookeeper，所以需要首先安装并启动zookeeper。可以使用kafka自带的zookeeper。</p>

<pre><code> bin/zookeeper-server-start.sh config/zookeeper.properties
</code></pre>

<p> 然后即可启动kafka</p>

<pre><code> bin/kafka-server-start.sh config/server.properties
</code></pre></li>
<li><p>创建topic</p>

<p> 消息传输需要指定topic。所以首先要创建一个topic。</p>

<pre><code> bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test
</code></pre>

<p> 之后，可以看到已经创建的topic.其中的replication-factor指的是复制因子，即log冗余的份数，这里的数字不能大于broker的数量。</p>

<pre><code> bin/kafka-topics.sh --list --zookeeper localhost:2181
</code></pre>

<p> 也可以不用手动创建topic，只需要配置broker的时候设置为auto-create topic when a non-existent topic is published to.</p></li>
<li><p>发送消息</p>

<p> kafka提供了一个命令行客户端，可以从一个文件或者标准输入里读取并发送到kafka集群。默认的，每一行都作为一个单独的消息。</p>

<pre><code> bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test 
</code></pre>

<p> 在命令行输入消息并回车即可发送消息。</p></li>
<li><p>启动一个消费者</p>

<p> kafka也提供了一个命令行消费者，接受消息并打印到标准输出。</p>

<pre><code> bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic test --from-beginning
</code></pre></li>
<li><p>设置多broker集群</p>

<p> 首先需要为每一个broker创建一个配置文件。</p>

<pre><code> cp config/server.properties config/server-1.properties 
 cp config/server.properties config/server-2.properties

 config/server-1.properties:
     broker.id=1
     port=9093
     log.dirs=/tmp/kafka-logs-1

 config/server-2.properties:
     broker.id=2
     port=9094
     log.dirs=/tmp/kafka-logs-2  
</code></pre>

<p> 然后启动这两个结点：</p>

<pre><code> bin/kafka-server-start.sh config/server-1.properties &amp;
 bin/kafka-server-start.sh config/server-2.properties &amp;
</code></pre>

<p> 现在一共有了三个结点，三个broker，那么这样就可以形成一个集群。</p>

<p> 创建一个复制引子为3的topic</p>

<pre><code> bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 3 --partitions 1 --topic my-replicated-topic
</code></pre>

<p> 如果想查看目前这个topic的partion在broker上的分布情况</p>

<pre><code> bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic my-replicated-topic
</code></pre></li>
</ol>


<h2>二. 关键配置</h2>

<h3>2.1 broker</h3>

<ul>
<li>broker.id: broker的唯一标识符，集群环境该值不可重复。</li>
<li>log.dirs: 一个用逗号分隔的目录列表，可以有多个，用来为Kafka存储数据。每当需要为一个新的partition分配一个目录时，会选择当前的存储partition最少的目录来存储。</li>
<li>zookeeper.connect：zookeeper访问地址，多个地址用’,’隔开</li>
</ul>


<h3>2.2 producer</h3>

<ul>
<li>metadata.broker.list： kafka的broker列表，格式为host1:port1,host2:port2</li>
<li>request.required.acks：用来控制一个produce请求怎样才能算完成，准确的说，是有多少broker必须已经提交数据到log文件，并向leader发送ack，可以设置如下的值：

<ul>
<li>0，意味着producer永远不会等待一个来自broker的ack，这就是0.7版本的行为。这个选项提供了最低的延迟，但是持久化的保证是最弱的，当server挂掉的时候会丢失一些数据。</li>
<li>1，意味着在leader replication已经接收到数据后，producer会得到一个ack。这个选项提供了更好的持久性。</li>
<li>-1，意味着在所有的ISR都接收到数据后，producer才得到一个ack。这个选项提供了最好的持久性，只要还有一个replication存活，那么数据就不会丢失。</li>
</ul>
</li>
<li>producer.type：决定消息是否应在一个后台线程异步发送。async表示异步发送；sync表示同步发送。设置为async则允许批量发送请求，这回带来更高的吞吐量，但是client的机器挂了的话会丢失还没有发送的数据。</li>
<li>serializer.class: 消息的序列化使用的class，如kafka.serializer.StringEncoder</li>
</ul>


<p>更多细节参见kafka.consumer.ProducerConfig类。</p>

<h3>2.3 consumer</h3>

<ul>
<li>group.id: 唯一的指明了consumer的group的名字，group名一样的进程属于同一个consumer group。</li>
<li>zookeeper.connect: 通broker的配置</li>
<li>consumer.id：consumer的唯一标识符，如果没有设置的话则自动生成。</li>
<li><strong><em>fetch.message.max.bytes</em></strong>：每一个获取某个topic的某个partition的请求，得到最大的字节数，每一个partition的要被读取的数据会加载入内存，所以这可以帮助控制consumer使用的内存。这个值的设置不能小于在server端设置的最大消息的字节数，否则producer可能会发送大于consumer可以获取的字节数限制的消息。默认值：1024 * 1024。</li>
<li><strong><em>fetch.min.bytes</em></strong>：一个fetch请求最少要返回多少字节的数据，如果数据量比这个配置少，则会等待，直到有足够的数据为止。默认值：1。</li>
<li><strong><em>fetch.wait.max.ms</em></strong>：在server回应fetch请求前，如果消息不足，就是说小于fetch.min.bytes时，server最多阻塞的时间。如果超时，消息将立即发送给consumer。默认值：100。</li>
</ul>


<p>更多细节参见kafka.consumer.ConsumerConfig类。</p>
</div>

</article>

	<div class="share">

     <!-- 多说分享 start-->
<div class="ds-share flat" data-title="kafka学习笔记 - 使用与配置 - 后端技术杂谈 | 飒然Hang" data-url="http://www.rowkey.me/blog/2015/05/30/kafka-usage/" data-content="此部分内容主要来自官方文档。 一. 使用 下载代码 https://www.apache.org/dyn/closer.cgi?path=/kafka/0.8.2.0/kafka_2.10-0.8.2.0.tgz tar -xzf kafka_2.10-0.8.2.0.tgz cd kafka_2 &hellip;">
    <div class="ds-share-inline">
      <ul  class="ds-share-icons-16">
      	
      	<li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
        <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
      	
      </ul>
      <div class="ds-share-icons-more">
      </div>
    </div>
 </div>
<!-- 多说分享 end-->
<!-- 多说评论框 start -->
<div class="ds-thread" data-title="kafka学习笔记 - 使用与配置"></div>
<!-- 多说评论框 end -->
<!-- UJian Button BEGIN -->
<div class="ujian-hook"></div>
<script type="text/javascript">var ujian_config = {num:8,showType:4};</script>
<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?uid=901552"></script>
<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
<!-- UJian Button END -->
 
</div>


</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2016

    飒然Hang


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
<link href="/stylesheets/scrollUp.min.css" media="screen, projection" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/javascripts/libs/jquery.scrollUp.min.js"></script>
<script type="text/javascript">
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
var duoshuoQuery = {short_name:"rowkey"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
<!-- 多说公共JS代码 end -->
$(function(){
	$.scrollUp({
		appendId: 'footer'
	});
});
</script>

	</footer>
		</div>
	</div>
	










</body>
</html>
